#!/bin/bash

# Reference: http://robertmuth.blogspot.com/2012/08/better-bash-scripting-in-15-minutes.html
set -o nounset

while true; do

############################################################
# Filesystem info.
FSINFO=$(df -PT | grep -v tmpfs | tail -n +2 | awk '{printf("%s(%s) ", $7, $6);}' )

############################################################
# Battery charge.

BATT_DEVICE="/sys/class/power_supply/BAT0"
BATTERY_FULL=`cat ${BATT_DEVICE}/charge_full`
BATTERY_NOW=`cat ${BATT_DEVICE}/charge_now`
BATTERY_PROC=`echo "100*$BATTERY_NOW/$BATTERY_FULL"|bc`

read BATTERY_STATUS < ${BATT_DEVICE}/status
case "$BATTERY_STATUS" in
    Full) 
	BATTERY_STATUS_CODE="-";;
    Discharging)
        BATTERY_STATUS_CODE="↓";;
    Charging)
	BATTERY_STATUS_CODE="↑";;
    Unknown)
	BATTERY_STATUS_CODE="?";;
    *)
	BATTERY_STATUS_CODE="???($BATTERY_STATUS)";;
esac

BATTERY_STATE="${BATTERY_PROC}${BATTERY_STATUS_CODE}"


############################################################
# Hibernate if battery is very low
[ \( "$BATTERY_PROC" -lt 3 \) -a \( "$BATTERY_STATUS" == "Discharging" \) ] && sudo systemctl hibernate


############################################################
# Network interfaces status

unset IFACE_INFO[*]
declare -A IFACE_INFO

IFACE_NAMES=$(ip -o link | grep -v -e link/loopback | awk -F ':' '{print $2;}')
for iface in $IFACE_NAMES; do
    IFACEDIR="/sys/class/net/${iface}"

    if [ -d "${IFACEDIR}" ]; then
	read STATE < "${IFACEDIR}/operstate"
	
	IFACE_INFO[$iface]="$iface: $STATE,"

	if [[ ${STATE} == "up" ]]; then
	    IWCONFIG=`/usr/sbin/iw dev ${iface} link 2>/dev/null`
	    
	    if [[ "${IWCONFIG}" != "Not connected." ]]; then
		ESSID=`echo "${IWCONFIG}" | grep "SSID" | cut -d" " -f 2-`
		STRENGTH=`echo "${IWCONFIG}" | grep "signal:" | cut -d" " -f 2-`
		IFACE_INFO[$iface]="$iface: ${ESSID} ${STRENGTH},"
	    fi
	fi
	
    fi
done

xsetroot -name "${FSINFO} | ${BATTERY_STATE} | ${IFACE_INFO[*]} | $(date -Is)"

sleep 1
done

