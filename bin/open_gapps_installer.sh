#!/usr/bin/env bash

## Category: Android
## Shortdesc: Bruteforce installed of OpenGAPPS on an AVD device running the plain AOSP image

#
# This script is based on a gist: https://gist.github.com/cunneen/1c0d9717f8ce5ea76900ba32fa037047
#
# I have cleaned it up a bit and made the following changes:
#
# - the temporary directory is now put where mktemp makes it
# - The script checks for the lzip command and fails if it's not installed
# - The script doesn't bother with copying system.img from the system-images dir in SDK to the AVD directory.
#   This is not required, you just need to keep starting the emulator with -writable-system instead of clicking
#   in the AVD GUI to make your changes persist.
# - The script doesn't bother with resizing the system.img filesystem image to make it work with x86 AOSP images.
#   In those images the system.img is a full block-device with MS-DOS partitioning. The sizes generated by AVD
#   by default were enough anyway...
#

ZIPFILE=${1}
USAGESTRING="Usage: ${0} open_gapps_zip_file.zip";
TEMPDIR=$(mktemp -d)

if ! which lzip; then
  echo "lzip command is not available, please install the lzip package"
  echo "For example, on OSX with homebrew: brew install lzip"
  exit 1
fi

if [ $# -lt 1 ]; then
  echo ${USAGESTRING};
  exit 1;
fi

if [ ! -f ${ZIPFILE} ]; then
  echo ${USAGESTRING};
  exit 2;
fi

if [ ! ${ANDROID_HOME} ]; then
  echo "ANDROID_HOME is not set"
  exit 3;
fi

if [ ! -d ${ANDROID_HOME} ]; then
  echo "ANDROID_HOME is not valid"
  exit 4;
fi

echo "Extracting OpenGapps '${ZIPFILE}' into '${TEMPDIR}'"

unzip ${ZIPFILE} 'Core/*' -d ${TEMPDIR}
cd ${TEMPDIR}
rm Core/setup*
lzip -d Core/*.lz
for f in $(ls Core/*.tar); do
  tar -x --strip-components 2 -f $f
done

echo "Which AVD?"
emulator -list-avds
echo -en "\n>"
read AVD

echo "starting ${AVD}"

emulator -netdelay none -netspeed full -avd ${AVD} -partition-size 1024 -writable-system & 

read -rsp $'\nPress enter when the emulator has booted...\n\n'

adb root
adb remount
adb push etc /system
adb push framework /system
adb push app /system
adb push priv-app /system

sleep 5
echo "Restart android in your emulator"
